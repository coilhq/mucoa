<?xml version="1.0" encoding="UTF-8" standalone="no"?><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" contentStyleType="text/css" height="463px" preserveAspectRatio="none" style="width:638px;height:463px;background:#FFFFFF;" version="1.1" viewBox="0 0 638 463" width="638px" zoomAndPan="magnify"><defs/><g><rect fill="#FFFFF9" height="444.9258" style="stroke:#181818;stroke-width:0.5;" width="190" x="16" y="6"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="119" x="49.5" y="19.4951">Central-Settlement</text><rect fill="#F9FFF9" height="444.9258" style="stroke:#181818;stroke-width:0.5;" width="347" x="279.5" y="6"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="50" x="426" y="19.4951">Storage</text><rect height="207.6523" style="stroke:#000000;stroke-width:1.5;fill:none;" width="622.5" x="10" y="159.6641"/><line style="stroke:#181818;stroke-width:0.5;fill:none;stroke-dasharray:5.0,5.0;" x1="111" x2="111" y1="89.9609" y2="384.3164"/><line style="stroke:#181818;stroke-width:0.5;fill:none;stroke-dasharray:5.0,5.0;" x1="346.5" x2="346.5" y1="89.9609" y2="384.3164"/><line style="stroke:#181818;stroke-width:0.5;fill:none;stroke-dasharray:5.0,5.0;" x1="490.5" x2="490.5" y1="89.9609" y2="384.3164"/><line style="stroke:#181818;stroke-width:0.5;fill:none;stroke-dasharray:5.0,5.0;" x1="596.5" x2="596.5" y1="89.9609" y2="384.3164"/><rect fill="#E2E2F0" height="49.2188" rx="2.5" ry="2.5" style="stroke:#181818;stroke-width:0.5;" width="182" x="20" y="39.7422"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="109" x="56.5" y="61.2754">Application Layer</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="168" x="27" y="78.8848">(domain / service / facade)</text><rect fill="#E2E2F0" height="49.2188" rx="2.5" ry="2.5" style="stroke:#181818;stroke-width:0.5;" width="182" x="20" y="383.3164"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="109" x="56.5" y="404.8496">Application Layer</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="168" x="27" y="422.459">(domain / service / facade)</text><rect fill="#D5E8D4" height="31.6094" rx="2.5" ry="2.5" style="stroke:#181818;stroke-width:0.5;" width="127" x="283.5" y="57.3516"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="113" x="290.5" y="78.8848">TigerBeetle Client</text><rect fill="#D5E8D4" height="31.6094" rx="2.5" ry="2.5" style="stroke:#181818;stroke-width:0.5;" width="127" x="283.5" y="383.3164"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="113" x="290.5" y="404.8496">TigerBeetle Client</text><rect fill="#D5E8D4" height="31.6094" style="stroke:#181818;stroke-width:0.5;" width="136" x="424.5" y="53.3516"/><rect fill="#D5E8D4" height="31.6094" style="stroke:#181818;stroke-width:0.5;" width="136" x="420.5" y="57.3516"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="122" x="427.5" y="78.8848">TigerBeetle Cluster</text><rect fill="#D5E8D4" height="31.6094" style="stroke:#181818;stroke-width:0.5;" width="136" x="424.5" y="383.3164"/><rect fill="#D5E8D4" height="31.6094" style="stroke:#181818;stroke-width:0.5;" width="136" x="420.5" y="387.3164"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="122" x="427.5" y="408.8496">TigerBeetle Cluster</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="46" x="570.5" y="86.8848">MySQL</text><path d="M578.5,36.3516 C578.5,26.3516 596.5,26.3516 596.5,26.3516 C596.5,26.3516 614.5,26.3516 614.5,36.3516 L614.5,62.3516 C614.5,72.3516 596.5,72.3516 596.5,72.3516 C596.5,72.3516 578.5,72.3516 578.5,62.3516 L578.5,36.3516 " fill="#DAE8FC" style="stroke:#181818;stroke-width:1.5;"/><path d="M578.5,36.3516 C578.5,46.3516 596.5,46.3516 596.5,46.3516 C596.5,46.3516 614.5,46.3516 614.5,36.3516 " fill="none" style="stroke:#181818;stroke-width:1.5;"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="46" x="570.5" y="397.8496">MySQL</text><path d="M578.5,410.9258 C578.5,400.9258 596.5,400.9258 596.5,400.9258 C596.5,400.9258 614.5,400.9258 614.5,410.9258 L614.5,436.9258 C614.5,446.9258 596.5,446.9258 596.5,446.9258 C596.5,446.9258 578.5,446.9258 578.5,436.9258 L578.5,410.9258 " fill="#DAE8FC" style="stroke:#181818;stroke-width:1.5;"/><path d="M578.5,410.9258 C578.5,420.9258 596.5,420.9258 596.5,420.9258 C596.5,420.9258 614.5,420.9258 614.5,410.9258 " fill="none" style="stroke:#181818;stroke-width:1.5;"/><path d="M17,104.9609 L17,146.9609 L204,146.9609 L204,114.9609 L194,104.9609 L17,104.9609 " fill="#FEFFDD" style="stroke:#181818;stroke-width:0.5;"/><path d="M194,104.9609 L194,114.9609 L204,114.9609 L194,104.9609 " fill="#FEFFDD" style="stroke:#181818;stroke-width:0.5;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="157" x="23" y="123.4561">Expose service functions &amp;</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="166" x="23" y="139.8076">handle database interactions</text><path d="M10,159.6641 L226,159.6641 L226,168.0156 L216,178.0156 L10,178.0156 L10,159.6641 " fill="#EEEEEE" style="stroke:#000000;stroke-width:1.5;"/><rect fill="none" height="207.6523" style="stroke:#000000;stroke-width:1.5;" width="622.5" x="10" y="159.6641"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="171" x="25" y="174.1592">Settlement Event - Reserve</text><polygon fill="#181818" points="122,213.3408,112,217.3408,122,221.3408,118,217.3408" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="116" x2="346" y1="217.3408" y2="217.3408"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="7" x="128" y="203.9976">1</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="46" x="139" y="195.5107">Retrieve</text><text fill="#000000" font-family="sans-serif" font-size="13" font-style="italic" lengthAdjust="spacing" textLength="55" x="189" y="195.5107">Transfers</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="23" x="248" y="195.5107">with</text><text fill="#000000" font-family="monospace" font-size="13" lengthAdjust="spacing" textLength="168" x="139" y="211.437">PS_TRANSFERS_RECORDED</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="29" x="311" y="212.4844">state</text><polygon fill="#181818" points="122,243.6924,112,247.6924,122,251.6924,118,247.6924" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="116" x2="346" y1="247.6924" y2="247.6924"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="7" x="128" y="242.8359">2</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="190" x="139" y="242.8359">Retrieve the settlement accounts</text><polygon fill="#181818" points="335,307.9912,345,311.9912,335,315.9912,339,311.9912" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="111" x2="341" y1="311.9912" y2="311.9912"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="7" x="118" y="290.1611">3</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="88" x="129" y="273.1875">Create 2-phase</text><text fill="#000000" font-family="sans-serif" font-size="13" font-style="italic" lengthAdjust="spacing" textLength="55" x="221" y="273.1875">Transfers</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="4" x="276" y="273.1875">:</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="4" x="129" y="290.1611">-</text><text fill="#000000" font-family="monospace" font-size="13" lengthAdjust="spacing" textLength="80" x="137" y="289.1138">SETTLEMENT</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="4" x="129" y="307.1348">-</text><text fill="#000000" font-family="monospace" font-size="13" lengthAdjust="spacing" textLength="144" x="137" y="306.0874">HUB_RECONCILIATION</text><polygon fill="#181818" points="584.5,355.3164,594.5,359.3164,584.5,363.3164,588.5,359.3164" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="111" x2="590.5" y1="359.3164" y2="359.3164"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="7" x="118" y="345.9731">4</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="154" x="129" y="337.4863">Update settlement state to</text><text fill="#000000" font-family="monospace" font-size="13" lengthAdjust="spacing" textLength="168" x="129" y="353.4126">PS_TRANSFERS_RESERVED</text><!--MD5=[e6c04813f7e62280a4ff672a36c7e0f0]
@startuml

box Central-Settlement #FFFFF9
    participant "Application Layer\n(domain / service / facade)" as cs_domain

    note over cs_domain
        Expose service functions &
        handle database interactions
    end note
end box

box Storage #F9FFF9
	participant "TigerBeetle Client" as tb_client #D5E8D4
	collections "TigerBeetle Cluster" as tb_nodes #D5E8D4
	database "MySQL" as cs_db #DAE8FC
end box

autonumber
group Settlement Event - Reserve
    'cs_domain -> cs_domain : Current state is **""PS_TRANSFERS_RECORDED""**, invoke ""settlementTransfersReserve"".
    'cs_domain -> cs_db : Lookup base settlement data.
    cs_domain <- - tb_client : Retrieve //Transfers// with \n""PS_TRANSFERS_RECORDED"" state
    cs_domain <- - tb_client : Retrieve the settlement accounts
    cs_domain -> tb_client : Create 2-phase //Transfers//:\n- ""SETTLEMENT""\n- ""HUB_RECONCILIATION""
    cs_domain -> cs_db : Update settlement state to \n""PS_TRANSFERS_RESERVED""
    'cs_domain - -> cs_db : Perform the following inserts/updates against the database:\n*- -//transferStateChange//- - Built in TB.\n*- -//participantPosition//- - Built in TB.\n*- -//participantPositionChange//- - Built in TB.
    'cs_domain -> tb_client : Lookup accounts associated with settlement via CS-TB interface:\n*//**tbLookupAccountsForSettlement**// - Based on ""settlementId"".
    'cs_domain -> tb_client : Create 2-phase transfer via CS-TB interface:\n*//**tbSettlementTransferReserve**//\n\n1x - __""SETTLEMENT""__:\n**//uuid()//** as ""id"",\n**//orgTransferId//** as ""user_data"".\n\n1x - __""HUB_RECONCILIATION""__:\n**//uuid()//** as ""id""\n**//orgTransferId//** as ""user_data"".
    'cs_domain -> cs_domain : Determine state and counters for settlement accounts.
    'cs_domain -> cs_domain : Continue the settlement process.
end

@enduml

@startuml

box Central-Settlement #FFFFF9
    participant "Application Layer\n(domain / service / facade)" as cs_domain

    note over cs_domain
        Expose service functions &
        handle database interactions
    end note
end box

box Storage #F9FFF9
	participant "TigerBeetle Client" as tb_client #D5E8D4
	collections "TigerBeetle Cluster" as tb_nodes #D5E8D4
	database "MySQL" as cs_db #DAE8FC
end box

autonumber
group Settlement Event - Reserve
    cs_domain <- - tb_client : Retrieve //Transfers// with \n""PS_TRANSFERS_RECORDED"" state
    cs_domain <- - tb_client : Retrieve the settlement accounts
    cs_domain -> tb_client : Create 2-phase //Transfers//:\n- ""SETTLEMENT""\n- ""HUB_RECONCILIATION""
    cs_domain -> cs_db : Update settlement state to \n""PS_TRANSFERS_RESERVED""
end

@enduml

PlantUML version 1.2022.4(Sat Apr 09 15:29:17 CAT 2022)
(GPL source distribution)
Java Runtime: OpenJDK Runtime Environment
JVM: OpenJDK 64-Bit Server VM
Default Encoding: Cp1252
Language: en
Country: ZA
--></g></svg>