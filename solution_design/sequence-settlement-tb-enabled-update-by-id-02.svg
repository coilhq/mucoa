<?xml version="1.0" encoding="UTF-8" standalone="no"?><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" contentStyleType="text/css" height="823px" preserveAspectRatio="none" style="width:977px;height:823px;background:#FFFFFF;" version="1.1" viewBox="0 0 977 823" width="977px" zoomAndPan="magnify"><defs/><g><rect fill="#FFFFF9" height="804.4923" style="stroke:#181818;stroke-width:0.5;" width="137" x="63" y="6"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="128" x="66" y="19.897">Central-Settlement</text><rect fill="#F9FFF9" height="804.4923" style="stroke:#181818;stroke-width:0.5;" width="361" x="604.5" y="6"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="51" x="758" y="19.897">Storage</text><rect height="560.2384" style="stroke:#000000;stroke-width:1.5;fill:none;" width="911.5" x="60" y="165.186"/><line style="stroke:#181818;stroke-width:0.5;fill:none;stroke-dasharray:5.0,5.0;" x1="131" x2="131" y1="92.7739" y2="742.4243"/><line style="stroke:#181818;stroke-width:0.5;fill:none;stroke-dasharray:5.0,5.0;" x1="675.5" x2="675.5" y1="92.7739" y2="742.4243"/><line style="stroke:#181818;stroke-width:0.5;fill:none;stroke-dasharray:5.0,5.0;" x1="825.5" x2="825.5" y1="92.7739" y2="742.4243"/><line style="stroke:#181818;stroke-width:0.5;fill:none;stroke-dasharray:5.0,5.0;" x1="935.5" x2="935.5" y1="92.7739" y2="742.4243"/><rect fill="#E2E2F0" height="33.0679" rx="2.5" ry="2.5" style="stroke:#181818;stroke-width:0.5;" width="123" x="70" y="58.706"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" text-decoration="underline" textLength="49" x="77" y="80.672">models</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="56" x="130" y="80.672">/ Facade</text><rect fill="#E2E2F0" height="33.0679" rx="2.5" ry="2.5" style="stroke:#181818;stroke-width:0.5;" width="123" x="70" y="741.4243"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" text-decoration="underline" textLength="49" x="77" y="763.3903">models</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="56" x="130" y="763.3903">/ Facade</text><rect fill="#D5E8D4" height="33.0679" rx="2.5" ry="2.5" style="stroke:#181818;stroke-width:0.5;" width="134" x="608.5" y="58.706"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="120" x="615.5" y="80.672">TigerBeetle Client</text><rect fill="#D5E8D4" height="33.0679" rx="2.5" ry="2.5" style="stroke:#181818;stroke-width:0.5;" width="134" x="608.5" y="741.4243"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="120" x="615.5" y="763.3903">TigerBeetle Client</text><rect fill="#D5E8D4" height="33.0679" style="stroke:#181818;stroke-width:0.5;" width="143" x="756.5" y="54.706"/><rect fill="#D5E8D4" height="33.0679" style="stroke:#181818;stroke-width:0.5;" width="143" x="752.5" y="58.706"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="129" x="759.5" y="80.672">TigerBeetle Cluster</text><rect fill="#D5E8D4" height="33.0679" style="stroke:#181818;stroke-width:0.5;" width="143" x="756.5" y="741.4243"/><rect fill="#D5E8D4" height="33.0679" style="stroke:#181818;stroke-width:0.5;" width="143" x="752.5" y="745.4243"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="129" x="759.5" y="767.3903">TigerBeetle Cluster</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="46" x="909.5" y="88.672">MySQL</text><path d="M917.5,37.706 C917.5,27.706 935.5,27.706 935.5,27.706 C935.5,27.706 953.5,27.706 953.5,37.706 L953.5,63.706 C953.5,73.706 935.5,73.706 935.5,73.706 C935.5,73.706 917.5,73.706 917.5,63.706 L917.5,37.706 " fill="#DAE8FC" style="stroke:#181818;stroke-width:1.5;"/><path d="M917.5,37.706 C917.5,47.706 935.5,47.706 935.5,47.706 C935.5,47.706 953.5,47.706 953.5,37.706 " fill="none" style="stroke:#181818;stroke-width:1.5;"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="46" x="909.5" y="756.3903">MySQL</text><path d="M917.5,770.4923 C917.5,760.4923 935.5,760.4923 935.5,760.4923 C935.5,760.4923 953.5,760.4923 953.5,770.4923 L953.5,796.4923 C953.5,806.4923 935.5,806.4923 935.5,806.4923 C935.5,806.4923 917.5,806.4923 917.5,796.4923 L917.5,770.4923 " fill="#DAE8FC" style="stroke:#181818;stroke-width:1.5;"/><path d="M917.5,770.4923 C917.5,780.4923 935.5,780.4923 935.5,780.4923 C935.5,780.4923 953.5,780.4923 953.5,770.4923 " fill="none" style="stroke:#181818;stroke-width:1.5;"/><path d="M5,107.7739 L5,152.7739 L259,152.7739 L259,117.7739 L249,107.7739 L5,107.7739 " fill="#FEFFDD" style="stroke:#181818;stroke-width:0.5;"/><path d="M249,107.7739 L249,117.7739 L259,117.7739 L249,107.7739 " fill="#FEFFDD" style="stroke:#181818;stroke-width:0.5;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="233" x="11" y="126.6709">Facade for storing/retrieving data from</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="139" x="11" y="144.377">MySQL and TigerBeetle</text><path d="M60,165.186 L629,165.186 L629,174.892 L619,184.892 L60,184.892 L60,165.186 " fill="#EEEEEE" style="stroke:#000000;stroke-width:1.5;"/><rect fill="none" height="560.2384" style="stroke:#000000;stroke-width:1.5;" width="911.5" x="60" y="165.186"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="122" x="75" y="180.083">Settlement Event -</text><text fill="#000000" font-family="monospace" font-size="13" font-style="italic" font-weight="bold" lengthAdjust="spacing" textLength="162" x="200" y="180.083">PS_TRANSFERS_RECORDED</text><text fill="#000000" font-family="sans-serif" font-size="13" font-style="italic" font-weight="bold" lengthAdjust="spacing" textLength="11" x="365" y="180.083">-&gt;</text><text fill="#000000" font-family="monospace" font-size="13" font-style="italic" font-weight="bold" lengthAdjust="spacing" textLength="157" x="379" y="180.083">PS_TRANSFERS_RESERVED</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="60" x="539" y="180.083">(putById)</text><line style="stroke:#181818;stroke-width:1.0;" x1="131.5" x2="173.5" y1="208.598" y2="208.598"/><line style="stroke:#181818;stroke-width:1.0;" x1="173.5" x2="173.5" y1="208.598" y2="221.598"/><line style="stroke:#181818;stroke-width:1.0;" x1="132.5" x2="173.5" y1="221.598" y2="221.598"/><polygon fill="#181818" points="142.5,217.598,132.5,221.598,142.5,225.598,138.5,221.598" style="stroke:#181818;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="7" x="138.5" y="202.789">1</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="91" x="149.5" y="202.789">Current state is</text><text fill="#000000" font-family="monospace" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="162" x="243.5" y="202.789">PS_TRANSFERS_RECORDED</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="46" x="405.5" y="202.789">, invoke</text><text fill="#000000" font-family="monospace" font-size="13" lengthAdjust="spacing" textLength="208" x="454.5" y="202.789">settlementTransfersReserve</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="3" x="662.5" y="202.789">.</text><polygon fill="#181818" points="923.5,249.304,933.5,253.304,923.5,257.304,927.5,253.304" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="131.5" x2="929.5" y1="253.304" y2="253.304"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="7" x="138.5" y="247.495">2</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="178" x="149.5" y="247.495">Lookup base settlement data.</text><polygon fill="#181818" points="663.5,298.716,673.5,302.716,663.5,306.716,667.5,302.716" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="131.5" x2="669.5" y1="302.716" y2="302.716"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="7" x="138.5" y="288.054">3</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="84" x="149.5" y="279.201">Retrieve list of</text><text fill="#000000" font-family="monospace" font-size="13" lengthAdjust="spacing" textLength="168" x="236.5" y="279.201">PS_TRANSFERS_RESERVED</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="51" x="404.5" y="279.201">, but not</text><text fill="#000000" font-family="monospace" font-size="13" lengthAdjust="spacing" textLength="64" x="458.5" y="279.201">RESERVED</text><ellipse cx="155" cy="293.216" fill="#000000" rx="2.5" ry="2.5" style="stroke:#000000;stroke-width:0.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-style="italic" font-weight="bold" lengthAdjust="spacing" textLength="116" x="161.5" y="296.907">tbLookupRecorded</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="62" x="280.5" y="296.907">- Based on</text><text fill="#000000" font-family="monospace" font-size="13" lengthAdjust="spacing" textLength="96" x="345.5" y="296.907">settlementId</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="3" x="441.5" y="296.907">.</text><polygon fill="#181818" points="923.5,383.5401,933.5,387.5401,923.5,391.5401,927.5,387.5401" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="131.5" x2="929.5" y1="387.5401" y2="387.5401"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="7" x="138.5" y="355.1721">4</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="358" x="149.5" y="328.6131">Perform the following inserts/updates against the database:</text><ellipse cx="155" cy="342.6281" fill="#000000" rx="2.5" ry="2.5" style="stroke:#000000;stroke-width:0.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-style="italic" lengthAdjust="spacing" text-decoration="line-through" textLength="118" x="161.5" y="346.3191">transferStateChange</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="62" x="282.5" y="346.3191">Built in TB.</text><ellipse cx="155" cy="360.3341" fill="#000000" rx="2.5" ry="2.5" style="stroke:#000000;stroke-width:0.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-style="italic" lengthAdjust="spacing" text-decoration="line-through" textLength="108" x="161.5" y="364.0251">participantPosition</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="62" x="272.5" y="364.0251">Built in TB.</text><ellipse cx="155" cy="378.0401" fill="#000000" rx="2.5" ry="2.5" style="stroke:#000000;stroke-width:0.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-style="italic" lengthAdjust="spacing" text-decoration="line-through" textLength="153" x="161.5" y="381.7311">participantPositionChange</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="62" x="317.5" y="381.7311">Built in TB.</text><polygon fill="#181818" points="663.5,432.9521,673.5,436.9521,663.5,440.9521,667.5,436.9521" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="131.5" x2="669.5" y1="436.9521" y2="436.9521"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="7" x="138.5" y="422.2901">5</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="381" x="149.5" y="413.4371">Lookup accounts associated with settlement via CS-TB interface:</text><ellipse cx="155" cy="427.4521" fill="#000000" rx="2.5" ry="2.5" style="stroke:#000000;stroke-width:0.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-style="italic" font-weight="bold" lengthAdjust="spacing" textLength="201" x="161.5" y="431.1431">tbLookupAccountsForSettlement</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="62" x="365.5" y="431.1431">- Based on</text><text fill="#000000" font-family="monospace" font-size="13" lengthAdjust="spacing" textLength="96" x="430.5" y="431.1431">settlementId</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="3" x="526.5" y="431.1431">.</text><polygon fill="#181818" points="663.5,624.0123,673.5,628.0123,663.5,632.0123,667.5,628.0123" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="131.5" x2="669.5" y1="628.0123" y2="628.0123"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="7" x="138.5" y="542.5262">6</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="254" x="149.5" y="462.8492">Create 2-phase transfer via CS-TB interface:</text><ellipse cx="155" cy="476.8642" fill="#000000" rx="2.5" ry="2.5" style="stroke:#000000;stroke-width:0.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-style="italic" font-weight="bold" lengthAdjust="spacing" textLength="178" x="161.5" y="480.5552">tbSettlementTransferReserve</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="3" x="149.5" y="498.2612"> </text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="21" x="149.5" y="515.9672">1x -</text><text fill="#000000" font-family="monospace" font-size="13" lengthAdjust="spacing" text-decoration="underline" textLength="80" x="173.5" y="515.9672">SETTLEMENT</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="3" x="253.5" y="515.9672">:</text><text fill="#000000" font-family="sans-serif" font-size="13" font-style="italic" font-weight="bold" lengthAdjust="spacing" textLength="36" x="149.5" y="533.6732">uuid()</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="13" x="188.5" y="533.6732">as</text><text fill="#000000" font-family="monospace" font-size="13" lengthAdjust="spacing" textLength="16" x="204.5" y="533.6732">id</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="3" x="220.5" y="533.6732">,</text><text fill="#000000" font-family="sans-serif" font-size="13" font-style="italic" font-weight="bold" lengthAdjust="spacing" textLength="85" x="149.5" y="551.3792">orgTransferId</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="13" x="237.5" y="551.3792">as</text><text fill="#000000" font-family="monospace" font-size="13" lengthAdjust="spacing" textLength="72" x="253.5" y="551.3792">user_data</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="3" x="325.5" y="551.3792">.</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="3" x="149.5" y="569.0853"> </text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="21" x="149.5" y="586.7913">1x -</text><text fill="#000000" font-family="monospace" font-size="13" lengthAdjust="spacing" text-decoration="underline" textLength="216" x="173.5" y="586.7913">HUB_MULTILATERAL_SETTLEMENT</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="3" x="389.5" y="586.7913">:</text><text fill="#000000" font-family="sans-serif" font-size="13" font-style="italic" font-weight="bold" lengthAdjust="spacing" textLength="36" x="149.5" y="604.4973">uuid()</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="13" x="188.5" y="604.4973">as</text><text fill="#000000" font-family="monospace" font-size="13" lengthAdjust="spacing" textLength="16" x="204.5" y="604.4973">id</text><text fill="#000000" font-family="sans-serif" font-size="13" font-style="italic" font-weight="bold" lengthAdjust="spacing" textLength="85" x="149.5" y="622.2033">orgTransferId</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="13" x="237.5" y="622.2033">as</text><text fill="#000000" font-family="monospace" font-size="13" lengthAdjust="spacing" textLength="72" x="253.5" y="622.2033">user_data</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="3" x="325.5" y="622.2033">.</text><line style="stroke:#181818;stroke-width:1.0;" x1="131.5" x2="173.5" y1="659.7183" y2="659.7183"/><line style="stroke:#181818;stroke-width:1.0;" x1="173.5" x2="173.5" y1="659.7183" y2="672.7183"/><line style="stroke:#181818;stroke-width:1.0;" x1="132.5" x2="173.5" y1="672.7183" y2="672.7183"/><polygon fill="#181818" points="142.5,668.7183,132.5,672.7183,142.5,676.7183,138.5,672.7183" style="stroke:#181818;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="7" x="138.5" y="653.9093">7</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="326" x="149.5" y="653.9093">Determine state and counters for settlement accounts.</text><line style="stroke:#181818;stroke-width:1.0;" x1="131.5" x2="173.5" y1="704.4243" y2="704.4243"/><line style="stroke:#181818;stroke-width:1.0;" x1="173.5" x2="173.5" y1="704.4243" y2="717.4243"/><line style="stroke:#181818;stroke-width:1.0;" x1="132.5" x2="173.5" y1="717.4243" y2="717.4243"/><polygon fill="#181818" points="142.5,713.4243,132.5,717.4243,142.5,721.4243,138.5,717.4243" style="stroke:#181818;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="7" x="138.5" y="698.6153">8</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="198" x="149.5" y="698.6153">Continue the settlement process.</text><!--MD5=[612147fc6c5e9ccfe1b85e2cdcb9f8bb]
@startuml

box Central-Settlement #FFFFF9
    participant "__models__ / Facade" as cs_facade

    note over cs_facade
        Facade for storing/retrieving data from
        MySQL and TigerBeetle
    end note
end box

box Storage #F9FFF9
	participant "TigerBeetle Client" as tb_client #D5E8D4
	collections "TigerBeetle Cluster" as tb_nodes #D5E8D4
	database "MySQL" as cl_db #DAE8FC
end box

autonumber
group Settlement Event - //""PS_TRANSFERS_RECORDED"" -> ""PS_TRANSFERS_RESERVED""// (putById)
    cs_facade -> cs_facade : Current state is **""PS_TRANSFERS_RECORDED""**, invoke ""settlementTransfersReserve"".
    cs_facade -> cl_db : Lookup base settlement data.
    cs_facade -> tb_client : Retrieve list of ""PS_TRANSFERS_RESERVED"", but not ""RESERVED""\n*//**tbLookupRecorded**// - Based on ""settlementId"".
    cs_facade - -> cl_db : Perform the following inserts/updates against the database:\n*- -//transferStateChange//- - Built in TB.\n*- -//participantPosition//- - Built in TB.\n*- -//participantPositionChange//- - Built in TB.
    cs_facade -> tb_client : Lookup accounts associated with settlement via CS-TB interface:\n*//**tbLookupAccountsForSettlement**// - Based on ""settlementId"".
    cs_facade -> tb_client : Create 2-phase transfer via CS-TB interface:\n*//**tbSettlementTransferReserve**//\n\n1x - __""SETTLEMENT""__:\n**//uuid()//** as ""id"",\n**//orgTransferId//** as ""user_data"".\n\n1x - __""HUB_MULTILATERAL_SETTLEMENT""__:\n**//uuid()//** as ""id""\n**//orgTransferId//** as ""user_data"".
    cs_facade -> cs_facade : Determine state and counters for settlement accounts.
    cs_facade -> cs_facade : Continue the settlement process.
end

@enduml

PlantUML version 1.2022.6(Tue Jun 21 19:34:49 CEST 2022)
(GPL source distribution)
Java Runtime: OpenJDK Runtime Environment
JVM: OpenJDK 64-Bit Server VM
Default Encoding: UTF-8
Language: en
Country: US
--></g></svg>