<?xml version="1.0" encoding="UTF-8" standalone="no"?><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" contentStyleType="text/css" height="841px" preserveAspectRatio="none" style="width:964px;height:841px;background:#FFFFFF;" version="1.1" viewBox="0 0 964 841" width="964px" zoomAndPan="magnify"><defs/><g><rect fill="#FFFFF9" height="822.1983" style="stroke:#181818;stroke-width:0.5;" width="137" x="63" y="6"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="128" x="66" y="19.897">Central-Settlement</text><rect fill="#F9FFF9" height="822.1983" style="stroke:#181818;stroke-width:0.5;" width="361" x="591.5" y="6"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="51" x="745" y="19.897">Storage</text><rect height="577.9444" style="stroke:#000000;stroke-width:1.5;fill:none;" width="898.5" x="60" y="165.186"/><line style="stroke:#181818;stroke-width:0.5;fill:none;stroke-dasharray:5.0,5.0;" x1="131" x2="131" y1="92.7739" y2="760.1304"/><line style="stroke:#181818;stroke-width:0.5;fill:none;stroke-dasharray:5.0,5.0;" x1="662.5" x2="662.5" y1="92.7739" y2="760.1304"/><line style="stroke:#181818;stroke-width:0.5;fill:none;stroke-dasharray:5.0,5.0;" x1="812.5" x2="812.5" y1="92.7739" y2="760.1304"/><line style="stroke:#181818;stroke-width:0.5;fill:none;stroke-dasharray:5.0,5.0;" x1="922.5" x2="922.5" y1="92.7739" y2="760.1304"/><rect fill="#E2E2F0" height="33.0679" rx="2.5" ry="2.5" style="stroke:#181818;stroke-width:0.5;" width="123" x="70" y="58.706"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" text-decoration="underline" textLength="49" x="77" y="80.672">models</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="56" x="130" y="80.672">/ Facade</text><rect fill="#E2E2F0" height="33.0679" rx="2.5" ry="2.5" style="stroke:#181818;stroke-width:0.5;" width="123" x="70" y="759.1304"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" text-decoration="underline" textLength="49" x="77" y="781.0963">models</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="56" x="130" y="781.0963">/ Facade</text><rect fill="#D5E8D4" height="33.0679" rx="2.5" ry="2.5" style="stroke:#181818;stroke-width:0.5;" width="134" x="595.5" y="58.706"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="120" x="602.5" y="80.672">TigerBeetle Client</text><rect fill="#D5E8D4" height="33.0679" rx="2.5" ry="2.5" style="stroke:#181818;stroke-width:0.5;" width="134" x="595.5" y="759.1304"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="120" x="602.5" y="781.0963">TigerBeetle Client</text><rect fill="#D5E8D4" height="33.0679" style="stroke:#181818;stroke-width:0.5;" width="143" x="743.5" y="54.706"/><rect fill="#D5E8D4" height="33.0679" style="stroke:#181818;stroke-width:0.5;" width="143" x="739.5" y="58.706"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="129" x="746.5" y="80.672">TigerBeetle Cluster</text><rect fill="#D5E8D4" height="33.0679" style="stroke:#181818;stroke-width:0.5;" width="143" x="743.5" y="759.1304"/><rect fill="#D5E8D4" height="33.0679" style="stroke:#181818;stroke-width:0.5;" width="143" x="739.5" y="763.1304"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="129" x="746.5" y="785.0963">TigerBeetle Cluster</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="46" x="896.5" y="88.672">MySQL</text><path d="M904.5,37.706 C904.5,27.706 922.5,27.706 922.5,27.706 C922.5,27.706 940.5,27.706 940.5,37.706 L940.5,63.706 C940.5,73.706 922.5,73.706 922.5,73.706 C922.5,73.706 904.5,73.706 904.5,63.706 L904.5,37.706 " fill="#DAE8FC" style="stroke:#181818;stroke-width:1.5;"/><path d="M904.5,37.706 C904.5,47.706 922.5,47.706 922.5,47.706 C922.5,47.706 940.5,47.706 940.5,37.706 " fill="none" style="stroke:#181818;stroke-width:1.5;"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="46" x="896.5" y="774.0963">MySQL</text><path d="M904.5,788.1983 C904.5,778.1983 922.5,778.1983 922.5,778.1983 C922.5,778.1983 940.5,778.1983 940.5,788.1983 L940.5,814.1983 C940.5,824.1983 922.5,824.1983 922.5,824.1983 C922.5,824.1983 904.5,824.1983 904.5,814.1983 L904.5,788.1983 " fill="#DAE8FC" style="stroke:#181818;stroke-width:1.5;"/><path d="M904.5,788.1983 C904.5,798.1983 922.5,798.1983 922.5,798.1983 C922.5,798.1983 940.5,798.1983 940.5,788.1983 " fill="none" style="stroke:#181818;stroke-width:1.5;"/><path d="M5,107.7739 L5,152.7739 L259,152.7739 L259,117.7739 L249,107.7739 L5,107.7739 " fill="#FEFFDD" style="stroke:#181818;stroke-width:0.5;"/><path d="M249,107.7739 L249,117.7739 L259,117.7739 L249,107.7739 " fill="#FEFFDD" style="stroke:#181818;stroke-width:0.5;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="233" x="11" y="126.6709">Facade for storing/retrieving data from</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="139" x="11" y="144.377">MySQL and TigerBeetle</text><path d="M60,165.186 L639,165.186 L639,174.892 L629,184.892 L60,184.892 L60,165.186 " fill="#EEEEEE" style="stroke:#000000;stroke-width:1.5;"/><rect fill="none" height="577.9444" style="stroke:#000000;stroke-width:1.5;" width="898.5" x="60" y="165.186"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="122" x="75" y="180.083">Settlement Event -</text><text fill="#000000" font-family="monospace" font-size="13" font-style="italic" font-weight="bold" lengthAdjust="spacing" textLength="157" x="200" y="180.083">PS_TRANSFERS_RESERVED</text><text fill="#000000" font-family="sans-serif" font-size="13" font-style="italic" font-weight="bold" lengthAdjust="spacing" textLength="11" x="360" y="180.083">-&gt;</text><text fill="#000000" font-family="monospace" font-size="13" font-style="italic" font-weight="bold" lengthAdjust="spacing" textLength="172" x="374" y="180.083">PS_TRANSFERS_COMMITTED</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="60" x="549" y="180.083">(putById)</text><line style="stroke:#181818;stroke-width:1.0;" x1="131.5" x2="173.5" y1="208.598" y2="208.598"/><line style="stroke:#181818;stroke-width:1.0;" x1="173.5" x2="173.5" y1="208.598" y2="221.598"/><line style="stroke:#181818;stroke-width:1.0;" x1="132.5" x2="173.5" y1="221.598" y2="221.598"/><polygon fill="#181818" points="142.5,217.598,132.5,221.598,142.5,225.598,138.5,221.598" style="stroke:#181818;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="7" x="138.5" y="202.789">1</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="91" x="149.5" y="202.789">Current state is</text><text fill="#000000" font-family="monospace" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="157" x="243.5" y="202.789">PS_TRANSFERS_RESERVED</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="46" x="400.5" y="202.789">, invoke</text><text fill="#000000" font-family="monospace" font-size="13" lengthAdjust="spacing" textLength="200" x="449.5" y="202.789">settlementTransfersCommit</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="3" x="649.5" y="202.789">.</text><polygon fill="#181818" points="910.5,249.304,920.5,253.304,910.5,257.304,914.5,253.304" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="131.5" x2="916.5" y1="253.304" y2="253.304"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="7" x="138.5" y="247.495">2</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="178" x="149.5" y="247.495">Lookup base settlement data.</text><polygon fill="#181818" points="650.5,298.716,660.5,302.716,650.5,306.716,654.5,302.716" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="131.5" x2="656.5" y1="302.716" y2="302.716"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="7" x="138.5" y="288.054">3</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="137" x="149.5" y="279.201">Retrieve list of pending</text><text fill="#000000" font-family="monospace" font-size="13" lengthAdjust="spacing" textLength="64" x="289.5" y="279.201">RESERVED</text><ellipse cx="155" cy="293.216" fill="#000000" rx="2.5" ry="2.5" style="stroke:#000000;stroke-width:0.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-style="italic" font-weight="bold" lengthAdjust="spacing" textLength="114" x="161.5" y="296.907">tbLookupReserved</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="62" x="278.5" y="296.907">- Based on</text><text fill="#000000" font-family="monospace" font-size="13" lengthAdjust="spacing" textLength="96" x="343.5" y="296.907">settlementId</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="3" x="439.5" y="296.907">.</text><polygon fill="#181818" points="910.5,401.2461,920.5,405.2461,910.5,409.2461,914.5,405.2461" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="131.5" x2="916.5" y1="405.2461" y2="405.2461"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="7" x="138.5" y="364.0251">4</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="358" x="149.5" y="328.6131">Perform the following inserts/updates against the database:</text><ellipse cx="155" cy="342.6281" fill="#000000" rx="2.5" ry="2.5" style="stroke:#000000;stroke-width:0.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-style="italic" lengthAdjust="spacing" text-decoration="line-through" textLength="189" x="161.5" y="346.3191">transferFulfilmentDuplicateCheck</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="62" x="353.5" y="346.3191">Built in TB.</text><ellipse cx="155" cy="360.3341" fill="#000000" rx="2.5" ry="2.5" style="stroke:#000000;stroke-width:0.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-style="italic" lengthAdjust="spacing" text-decoration="line-through" textLength="101" x="161.5" y="364.0251">transferFulfilment</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="62" x="265.5" y="364.0251">Built in TB.</text><ellipse cx="155" cy="378.0401" fill="#000000" rx="2.5" ry="2.5" style="stroke:#000000;stroke-width:0.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-style="italic" lengthAdjust="spacing" text-decoration="line-through" textLength="118" x="161.5" y="381.7311">transferStateChange</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="62" x="282.5" y="381.7311">Built in TB.</text><ellipse cx="155" cy="395.7461" fill="#000000" rx="2.5" ry="2.5" style="stroke:#000000;stroke-width:0.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-style="italic" lengthAdjust="spacing" text-decoration="line-through" textLength="108" x="161.5" y="399.4371">participantPosition</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="62" x="272.5" y="399.4371">Built in TB.</text><polygon fill="#181818" points="650.5,450.6582,660.5,454.6582,650.5,458.6582,654.5,454.6582" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="131.5" x2="656.5" y1="454.6582" y2="454.6582"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="7" x="138.5" y="439.9962">5</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="381" x="149.5" y="431.1431">Lookup accounts associated with settlement via CS-TB interface:</text><ellipse cx="155" cy="445.1582" fill="#000000" rx="2.5" ry="2.5" style="stroke:#000000;stroke-width:0.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-style="italic" font-weight="bold" lengthAdjust="spacing" textLength="201" x="161.5" y="448.8492">tbLookupAccountsForSettlement</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="62" x="365.5" y="448.8492">- Based on</text><text fill="#000000" font-family="monospace" font-size="13" lengthAdjust="spacing" textLength="96" x="430.5" y="448.8492">settlementId</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="3" x="526.5" y="448.8492">.</text><polygon fill="#181818" points="650.5,641.7183,660.5,645.7183,650.5,649.7183,654.5,645.7183" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="131.5" x2="656.5" y1="645.7183" y2="645.7183"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="7" x="138.5" y="560.2323">6</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="284" x="149.5" y="480.5552">Create 2-phase transfer post via CS-TB interface:</text><ellipse cx="155" cy="494.5702" fill="#000000" rx="2.5" ry="2.5" style="stroke:#000000;stroke-width:0.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-style="italic" font-weight="bold" lengthAdjust="spacing" textLength="180" x="161.5" y="498.2612">tbSettlementTransferCommit</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="3" x="149.5" y="515.9672"> </text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="21" x="149.5" y="533.6732">1x -</text><text fill="#000000" font-family="monospace" font-size="13" lengthAdjust="spacing" text-decoration="underline" textLength="80" x="173.5" y="533.6732">SETTLEMENT</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="3" x="253.5" y="533.6732">:</text><text fill="#000000" font-family="sans-serif" font-size="13" font-style="italic" font-weight="bold" lengthAdjust="spacing" textLength="181" x="149.5" y="551.3792">sha256(settlementTransferId)</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="13" x="333.5" y="551.3792">as</text><text fill="#000000" font-family="monospace" font-size="13" lengthAdjust="spacing" textLength="16" x="349.5" y="551.3792">id</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="3" x="365.5" y="551.3792">,</text><text fill="#000000" font-family="sans-serif" font-size="13" font-style="italic" font-weight="bold" lengthAdjust="spacing" textLength="15" x="149.5" y="569.0853">0n</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="13" x="167.5" y="569.0853">as</text><text fill="#000000" font-family="monospace" font-size="13" lengthAdjust="spacing" textLength="72" x="183.5" y="569.0853">user_data</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="3" x="255.5" y="569.0853">.</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="3" x="149.5" y="586.7913"> </text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="21" x="149.5" y="604.4973">1x -</text><text fill="#000000" font-family="monospace" font-size="13" lengthAdjust="spacing" text-decoration="underline" textLength="144" x="173.5" y="604.4973">HUB_RECONCILIATION</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="3" x="317.5" y="604.4973">:</text><text fill="#000000" font-family="sans-serif" font-size="13" font-style="italic" font-weight="bold" lengthAdjust="spacing" textLength="36" x="149.5" y="622.2033">uuid()</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="13" x="188.5" y="622.2033">as</text><text fill="#000000" font-family="monospace" font-size="13" lengthAdjust="spacing" textLength="16" x="204.5" y="622.2033">id</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="3" x="220.5" y="622.2033">,</text><text fill="#000000" font-family="sans-serif" font-size="13" font-style="italic" font-weight="bold" lengthAdjust="spacing" textLength="15" x="149.5" y="639.9093">0n</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="13" x="167.5" y="639.9093">as</text><text fill="#000000" font-family="monospace" font-size="13" lengthAdjust="spacing" textLength="72" x="183.5" y="639.9093">user_data</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="3" x="255.5" y="639.9093">.</text><line style="stroke:#181818;stroke-width:1.0;" x1="131.5" x2="173.5" y1="677.4243" y2="677.4243"/><line style="stroke:#181818;stroke-width:1.0;" x1="173.5" x2="173.5" y1="677.4243" y2="690.4243"/><line style="stroke:#181818;stroke-width:1.0;" x1="132.5" x2="173.5" y1="690.4243" y2="690.4243"/><polygon fill="#181818" points="142.5,686.4243,132.5,690.4243,142.5,694.4243,138.5,690.4243" style="stroke:#181818;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="7" x="138.5" y="671.6153">7</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="326" x="149.5" y="671.6153">Determine state and counters for settlement accounts.</text><line style="stroke:#181818;stroke-width:1.0;" x1="131.5" x2="173.5" y1="722.1304" y2="722.1304"/><line style="stroke:#181818;stroke-width:1.0;" x1="173.5" x2="173.5" y1="722.1304" y2="735.1304"/><line style="stroke:#181818;stroke-width:1.0;" x1="132.5" x2="173.5" y1="735.1304" y2="735.1304"/><polygon fill="#181818" points="142.5,731.1304,132.5,735.1304,142.5,739.1304,138.5,735.1304" style="stroke:#181818;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="7" x="138.5" y="716.3214">8</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="198" x="149.5" y="716.3214">Continue the settlement process.</text><!--MD5=[5c9410f254e5e36802adbe448a4265aa]
@startuml

box Central-Settlement #FFFFF9
    participant "__models__ / Facade" as cs_facade

    note over cs_facade
        Facade for storing/retrieving data from
        MySQL and TigerBeetle
    end note
end box

box Storage #F9FFF9
	participant "TigerBeetle Client" as tb_client #D5E8D4
	collections "TigerBeetle Cluster" as tb_nodes #D5E8D4
	database "MySQL" as cl_db #DAE8FC
end box

autonumber
group Settlement Event - //""PS_TRANSFERS_RESERVED"" -> ""PS_TRANSFERS_COMMITTED""// (putById)
    cs_facade -> cs_facade : Current state is **""PS_TRANSFERS_RESERVED""**, invoke ""settlementTransfersCommit"".
    cs_facade -> cl_db : Lookup base settlement data.
    cs_facade -> tb_client : Retrieve list of pending ""RESERVED""\n*//**tbLookupReserved**// - Based on ""settlementId"".
    cs_facade - -> cl_db : Perform the following inserts/updates against the database:\n*- -//transferFulfilmentDuplicateCheck//- - Built in TB.\n*- -//transferFulfilment//- - Built in TB.\n*- -//transferStateChange//- - Built in TB.\n*- -//participantPosition//- - Built in TB.
    cs_facade -> tb_client : Lookup accounts associated with settlement via CS-TB interface:\n*//**tbLookupAccountsForSettlement**// - Based on ""settlementId"".
    cs_facade -> tb_client : Create 2-phase transfer post via CS-TB interface:\n*//**tbSettlementTransferCommit**//\n\n1x - __""SETTLEMENT""__:\n**//sha256(settlementTransferId)//** as ""id"", \n**//0n//** as ""user_data"".\n\n1x - __""HUB_RECONCILIATION""__:\n**//uuid()//** as ""id"", \n**//0n//** as ""user_data"".
    cs_facade -> cs_facade : Determine state and counters for settlement accounts.
    cs_facade -> cs_facade : Continue the settlement process.
end

@enduml

PlantUML version 1.2022.6(Tue Jun 21 19:34:49 CEST 2022)
(GPL source distribution)
Java Runtime: OpenJDK Runtime Environment
JVM: OpenJDK 64-Bit Server VM
Default Encoding: UTF-8
Language: en
Country: US
--></g></svg>