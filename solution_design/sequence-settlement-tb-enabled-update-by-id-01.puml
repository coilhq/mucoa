@startuml

box Central-Settlement #FFFFF9
    participant "__models__ / Facade" as cs_facade

    note over cs_facade
        Facade for storing/retrieving data from
        MySQL and TigerBeetle
    end note
end box

box Storage #F9FFF9
	participant "TigerBeetle Client" as tb_client #D5E8D4
	collections "TigerBeetle Cluster" as tb_nodes #D5E8D4
	database "MySQL" as cl_db #DAE8FC
end box

autonumber
group Settlement Event - //""PENDING_SETTLEMENT"" -> ""PS_TRANSFERS_RECORDED""// (putById)
    cs_facade -> cs_facade : Current state is **""PENDING_SETTLEMENT""**, invoke ""settlementTransfersPrepare"".
    cs_facade -> cl_db : Lookup base settlement data.
    cs_facade -> tb_client : Retrieve list of ""PS_TRANSFERS_RECORDED"", but not ""RECEIVED_PREPARE"".PENDING_SETTLEMENT \n*//**tbLookupTransferForWindow**// - Based on ""settlementWindowId"".
    cs_facade --> cl_db : Perform the following inserts against the database:\n*--//transferDuplicateCheck//-- Built in TB.\n*--//transfer//-- Built in TB.\n*--//transferParticipant//-- Built in TB.\n*--//transferStateChange//-- Built in TB.
    cs_facade -> tb_client : Lookup accounts associated with settlement via CS-TB interface:\n*//**tbLookupAccountsForSettlement**// - Based on ""settlementId"".
    cs_facade -> tb_client : Create 1-phase transfer via CS-TB interface:\n*//**tbSettlementPreparationTransfer**//\n\n1x - __""HUB_MULTILATERAL_SETTLEMENT""__:\n**//settlementId//** as ""user_data"", \n**//transferId//** as ""id"".\n\n1x - __""SETTLEMENT""__:\n**//orgTransferId//** as ""user_data""\n**//uuid()//** as ""id"".
    cs_facade -> cs_facade : Determine state and counters for settlement accounts.
    cs_facade -> cs_facade : Continue the settlement process.
end

@enduml
