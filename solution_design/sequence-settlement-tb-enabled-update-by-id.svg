<?xml version="1.0" encoding="UTF-8" standalone="no"?><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" contentStyleType="text/css" height="1796px" preserveAspectRatio="none" style="width:1830px;height:1796px;background:#FFFFFF;" version="1.1" viewBox="0 0 1830 1796" width="1830px" zoomAndPan="magnify"><defs/><g><rect fill="#FFFFF9" height="1777.4968" style="stroke:#181818;stroke-width:0.5;" width="627.5" x="312" y="6"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="128" x="560.25" y="19.897">Central-Settlement</text><rect fill="#F9FFF9" height="1777.4968" style="stroke:#181818;stroke-width:0.5;" width="470" x="1337" y="6"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="51" x="1545" y="19.897">Storage</text><rect height="1311.5948" style="stroke:#000000;stroke-width:1.5;fill:none;" width="1803" x="10" y="386.8341"/><line style="stroke:#181818;stroke-width:0.5;fill:none;stroke-dasharray:5.0,5.0;" x1="87" x2="87" y1="92.7739" y2="1715.4289"/><line style="stroke:#181818;stroke-width:0.5;fill:none;stroke-dasharray:5.0,5.0;" x1="335" x2="335" y1="92.7739" y2="1715.4289"/><line style="stroke:#181818;stroke-width:0.5;fill:none;stroke-dasharray:5.0,5.0;" x1="573" x2="573" y1="92.7739" y2="1715.4289"/><line style="stroke:#181818;stroke-width:0.5;fill:none;stroke-dasharray:5.0,5.0;" x1="734" x2="734" y1="92.7739" y2="1715.4289"/><line style="stroke:#181818;stroke-width:0.5;fill:none;stroke-dasharray:5.0,5.0;" x1="873.5" x2="873.5" y1="92.7739" y2="1715.4289"/><line style="stroke:#181818;stroke-width:0.5;fill:none;stroke-dasharray:5.0,5.0;" x1="1408" x2="1408" y1="92.7739" y2="1715.4289"/><line style="stroke:#181818;stroke-width:0.5;fill:none;stroke-dasharray:5.0,5.0;" x1="1629.5" x2="1629.5" y1="92.7739" y2="1715.4289"/><line style="stroke:#181818;stroke-width:0.5;fill:none;stroke-dasharray:5.0,5.0;" x1="1777" x2="1777" y1="92.7739" y2="1715.4289"/><rect fill="#B0D5FF" height="33.0679" rx="2.5" ry="2.5" style="stroke:#181818;stroke-width:0.5;" width="134" x="20" y="58.706"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="120" x="27" y="80.672">Mojaloop Adapter</text><rect fill="#B0D5FF" height="33.0679" rx="2.5" ry="2.5" style="stroke:#181818;stroke-width:0.5;" width="134" x="20" y="1714.4289"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="120" x="27" y="1736.3948">Mojaloop Adapter</text><rect fill="#E2E2F0" height="33.0679" rx="2.5" ry="2.5" style="stroke:#181818;stroke-width:0.5;" width="38" x="316" y="58.706"/><text fill="#000000" font-family="sans-serif" font-size="14" font-weight="bold" lengthAdjust="spacing" textLength="24" x="323" y="80.672">API</text><rect fill="#E2E2F0" height="33.0679" rx="2.5" ry="2.5" style="stroke:#181818;stroke-width:0.5;" width="38" x="316" y="1714.4289"/><text fill="#000000" font-family="sans-serif" font-size="14" font-weight="bold" lengthAdjust="spacing" textLength="24" x="323" y="1736.3948">API</text><rect fill="#E2E2F0" height="33.0679" rx="2.5" ry="2.5" style="stroke:#181818;stroke-width:0.5;" width="102" x="522" y="58.706"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" text-decoration="underline" textLength="21" x="529" y="80.672">api</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="63" x="554" y="80.672">/ Handler</text><rect fill="#E2E2F0" height="33.0679" rx="2.5" ry="2.5" style="stroke:#181818;stroke-width:0.5;" width="102" x="522" y="1714.4289"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" text-decoration="underline" textLength="21" x="529" y="1736.3948">api</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="63" x="554" y="1736.3948">/ Handler</text><rect fill="#E2E2F0" height="33.0679" rx="2.5" ry="2.5" style="stroke:#181818;stroke-width:0.5;" width="126" x="671" y="58.706"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" text-decoration="underline" textLength="51" x="678" y="80.672">domain</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="57" x="733" y="80.672">/ Service</text><rect fill="#E2E2F0" height="33.0679" rx="2.5" ry="2.5" style="stroke:#181818;stroke-width:0.5;" width="126" x="671" y="1714.4289"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" text-decoration="underline" textLength="51" x="678" y="1736.3948">domain</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="57" x="733" y="1736.3948">/ Service</text><rect fill="#E2E2F0" height="33.0679" rx="2.5" ry="2.5" style="stroke:#181818;stroke-width:0.5;" width="123" x="812.5" y="58.706"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" text-decoration="underline" textLength="49" x="819.5" y="80.672">models</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="56" x="872.5" y="80.672">/ Facade</text><rect fill="#E2E2F0" height="33.0679" rx="2.5" ry="2.5" style="stroke:#181818;stroke-width:0.5;" width="123" x="812.5" y="1714.4289"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" text-decoration="underline" textLength="49" x="819.5" y="1736.3948">models</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="56" x="872.5" y="1736.3948">/ Facade</text><rect fill="#D5E8D4" height="33.0679" rx="2.5" ry="2.5" style="stroke:#181818;stroke-width:0.5;" width="134" x="1341" y="58.706"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="120" x="1348" y="80.672">TigerBeetle Client</text><rect fill="#D5E8D4" height="33.0679" rx="2.5" ry="2.5" style="stroke:#181818;stroke-width:0.5;" width="134" x="1341" y="1714.4289"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="120" x="1348" y="1736.3948">TigerBeetle Client</text><rect fill="#D5E8D4" height="33.0679" style="stroke:#181818;stroke-width:0.5;" width="143" x="1560.5" y="54.706"/><rect fill="#D5E8D4" height="33.0679" style="stroke:#181818;stroke-width:0.5;" width="143" x="1556.5" y="58.706"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="129" x="1563.5" y="80.672">TigerBeetle Cluster</text><rect fill="#D5E8D4" height="33.0679" style="stroke:#181818;stroke-width:0.5;" width="143" x="1560.5" y="1714.4289"/><rect fill="#D5E8D4" height="33.0679" style="stroke:#181818;stroke-width:0.5;" width="143" x="1556.5" y="1718.4289"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="129" x="1563.5" y="1740.3948">TigerBeetle Cluster</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="46" x="1751" y="88.672">MySQL</text><path d="M1759,37.706 C1759,27.706 1777,27.706 1777,27.706 C1777,27.706 1795,27.706 1795,37.706 L1795,63.706 C1795,73.706 1777,73.706 1777,73.706 C1777,73.706 1759,73.706 1759,63.706 L1759,37.706 " fill="#DAE8FC" style="stroke:#181818;stroke-width:1.5;"/><path d="M1759,37.706 C1759,47.706 1777,47.706 1777,47.706 C1777,47.706 1795,47.706 1795,37.706 " fill="none" style="stroke:#181818;stroke-width:1.5;"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="46" x="1751" y="1729.3948">MySQL</text><path d="M1759,1743.4968 C1759,1733.4968 1777,1733.4968 1777,1733.4968 C1777,1733.4968 1795,1733.4968 1795,1743.4968 L1795,1769.4968 C1795,1779.4968 1777,1779.4968 1777,1779.4968 C1777,1779.4968 1759,1779.4968 1759,1769.4968 L1759,1743.4968 " fill="#DAE8FC" style="stroke:#181818;stroke-width:1.5;"/><path d="M1759,1743.4968 C1759,1753.4968 1777,1753.4968 1777,1753.4968 C1777,1753.4968 1795,1753.4968 1795,1743.4968 " fill="none" style="stroke:#181818;stroke-width:1.5;"/><path d="M16,107.7739 L16,152.7739 L158,152.7739 L158,117.7739 L148,107.7739 L16,107.7739 " fill="#FEFFDD" style="stroke:#181818;stroke-width:0.5;"/><path d="M148,107.7739 L148,117.7739 L158,117.7739 L148,107.7739 " fill="#FEFFDD" style="stroke:#181818;stroke-width:0.5;"/><ellipse cx="27.5" cy="122.9799" fill="#000000" rx="2.5" ry="2.5" style="stroke:#000000;stroke-width:0.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="109" x="34" y="126.6709">Participant Bank A</text><ellipse cx="27.5" cy="140.686" fill="#000000" rx="2.5" ry="2.5" style="stroke:#000000;stroke-width:0.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="109" x="34" y="144.377">Participant Bank B</text><path d="M274,163.186 L274,208.186 L396,208.186 L396,173.186 L386,163.186 L274,163.186 " fill="#FEFFDD" style="stroke:#181818;stroke-width:0.5;"/><path d="M386,163.186 L386,173.186 L396,173.186 L386,163.186 " fill="#FEFFDD" style="stroke:#181818;stroke-width:0.5;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="99" x="280" y="182.083">NodeJS interface</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="101" x="280" y="199.789">invokes REST API</text><path d="M474,218.598 L474,263.598 L672,263.598 L672,228.598 L662,218.598 L474,218.598 " fill="#FEFFDD" style="stroke:#181818;stroke-width:0.5;"/><path d="M662,218.598 L662,228.598 L672,228.598 L662,218.598 " fill="#FEFFDD" style="stroke:#181818;stroke-width:0.5;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="177" x="480" y="237.495">JSON request decoded &amp; sent</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="164" x="480" y="255.201">for processing via a handler</text><path d="M627,274.01 L627,319.01 L840,319.01 L840,284.01 L830,274.01 L627,274.01 " fill="#FEFFDD" style="stroke:#181818;stroke-width:0.5;"/><path d="M830,274.01 L830,284.01 L840,284.01 L830,274.01 " fill="#FEFFDD" style="stroke:#181818;stroke-width:0.5;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="192" x="633" y="292.907">Domain folder where the service</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="135" x="633" y="310.6131">functions are exposed.</text><path d="M747,329.4221 L747,374.4221 L1001,374.4221 L1001,339.4221 L991,329.4221 L747,329.4221 " fill="#FEFFDD" style="stroke:#181818;stroke-width:0.5;"/><path d="M991,329.4221 L991,339.4221 L1001,339.4221 L991,329.4221 " fill="#FEFFDD" style="stroke:#181818;stroke-width:0.5;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="233" x="753" y="348.3191">Facade for storing/retrieving data from</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="139" x="753" y="366.0251">MySQL and TigerBeetle</text><path d="M10,386.8341 L370,386.8341 L370,396.5401 L360,406.5401 L10,406.5401 L10,386.8341 " fill="#EEEEEE" style="stroke:#000000;stroke-width:1.5;"/><rect fill="none" height="1311.5948" style="stroke:#000000;stroke-width:1.5;" width="1803" x="10" y="386.8341"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="173" x="25" y="401.7311">Trigger Settlement Event -</text><text fill="#000000" font-family="sans-serif" font-size="13" font-style="italic" font-weight="bold" lengthAdjust="spacing" textLength="139" x="201" y="401.7311">updateSettlementById</text><polygon fill="#181818" points="323,443.9521,333,447.9521,323,451.9521,327,447.9521" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="87" x2="329" y1="447.9521" y2="447.9521"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="7" x="94" y="433.2901">1</text><text fill="#000000" font-family="sans-serif" font-size="13" font-style="italic" lengthAdjust="spacing" textLength="29" x="105" y="424.4371">JSON</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="3" x="134" y="424.4371"> </text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="115" x="105" y="442.1431">(settlement data)</text><polygon fill="#181818" points="561,493.3642,571,497.3642,561,501.3642,565,497.3642" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="335" x2="567" y1="497.3642" y2="497.3642"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="7" x="342" y="482.7022">2</text><text fill="#000000" font-family="sans-serif" font-size="13" font-style="italic" lengthAdjust="spacing" textLength="200" x="353" y="473.8492">/settlements/updateSettlementById</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="3" x="553" y="473.8492"> </text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="99" x="353" y="491.5552">Handler invoked</text><polygon fill="#181818" points="722,542.7762,732,546.7762,722,550.7762,726,546.7762" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="573" x2="728" y1="546.7762" y2="546.7762"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="7" x="580" y="532.1142">3</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="125" x="591" y="523.2612">Service layer invoked</text><text fill="#000000" font-family="sans-serif" font-size="13" font-style="italic" lengthAdjust="spacing" textLength="126" x="591" y="540.9672">updateSettlementById</text><polygon fill="#181818" points="862,592.1882,872,596.1882,862,600.1882,866,596.1882" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="734" x2="868" y1="596.1882" y2="596.1882"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="7" x="741" y="581.5262">4</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="105" x="752" y="572.6732">Domain to facade</text><text fill="#000000" font-family="sans-serif" font-size="13" font-style="italic" lengthAdjust="spacing" textLength="46" x="752" y="590.3792">putById</text><polygon fill="#181818" points="1765,623.8943,1775,627.8943,1765,631.8943,1769,627.8943" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="874" x2="1771" y1="627.8943" y2="627.8943"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="7" x="881" y="622.0853">5</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="178" x="892" y="622.0853">Lookup base settlement data.</text><polygon fill="#181818" points="1396,673.3063,1406,677.3063,1396,681.3063,1400,677.3063" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="874" x2="1402" y1="677.3063" y2="677.3063"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="7" x="881" y="662.6443">6</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="376" x="892" y="653.7913">Lookup accounts associated with setlement via CS-TB interface:</text><ellipse cx="897.5" cy="667.8063" fill="#000000" rx="2.5" ry="2.5" style="stroke:#000000;stroke-width:0.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-style="italic" font-weight="bold" lengthAdjust="spacing" textLength="201" x="904" y="671.4973">tbLookupAccountsForSettlement</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="145" x="1108" y="671.4973">- Based on settlementId.</text><line style="stroke:#181818;stroke-width:1.0;" x1="874" x2="916" y1="709.0123" y2="709.0123"/><line style="stroke:#181818;stroke-width:1.0;" x1="916" x2="916" y1="709.0123" y2="722.0123"/><line style="stroke:#181818;stroke-width:1.0;" x1="875" x2="916" y1="722.0123" y2="722.0123"/><polygon fill="#181818" points="885,718.0123,875,722.0123,885,726.0123,881,722.0123" style="stroke:#181818;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="7" x="881" y="703.2033">7</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="326" x="892" y="703.2033">Determine state and counters for settlement accounts.</text><polygon fill="#181818" points="1765,891.3665,1775,895.3665,1765,899.3665,1769,895.3665" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="874" x2="1771" y1="895.3665" y2="895.3665"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="7" x="881" y="818.7334">8</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="304" x="892" y="747.9093">Perform the following inserts against the database:</text><ellipse cx="897.5" cy="761.9243" fill="#000000" rx="2.5" ry="2.5" style="stroke:#000000;stroke-width:0.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-style="italic" lengthAdjust="spacing" textLength="58" x="904" y="765.6153">settlement</text><ellipse cx="897.5" cy="779.6304" fill="#000000" rx="2.5" ry="2.5" style="stroke:#000000;stroke-width:0.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-style="italic" lengthAdjust="spacing" textLength="163" x="904" y="783.3214">settlementSettlementWindow</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="169" x="1070" y="783.3214">for each settlement window.</text><ellipse cx="897.5" cy="797.3364" fill="#000000" rx="2.5" ry="2.5" style="stroke:#000000;stroke-width:0.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-style="italic" lengthAdjust="spacing" text-decoration="line-through" textLength="172" x="904" y="801.0274">settlementParticipantCurrency</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="62" x="1079" y="801.0274">Built in TB.</text><ellipse cx="897.5" cy="815.0424" fill="#000000" rx="2.5" ry="2.5" style="stroke:#000000;stroke-width:0.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-style="italic" lengthAdjust="spacing" text-decoration="line-through" textLength="149" x="904" y="818.7334">settlementWindowContent</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="62" x="1056" y="818.7334">Built in TB.</text><ellipse cx="897.5" cy="832.7484" fill="#000000" rx="2.5" ry="2.5" style="stroke:#000000;stroke-width:0.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-style="italic" lengthAdjust="spacing" text-decoration="line-through" textLength="222" x="904" y="836.4394">settlementWindowContentStateChange</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="62" x="1129" y="836.4394">Built in TB.</text><ellipse cx="897.5" cy="850.4544" fill="#000000" rx="2.5" ry="2.5" style="stroke:#000000;stroke-width:0.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-style="italic" lengthAdjust="spacing" text-decoration="line-through" textLength="245" x="904" y="854.1454">settlementParticipantCurrencyStateChange</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="62" x="1152" y="854.1454">Built in TB.</text><ellipse cx="897.5" cy="868.1604" fill="#000000" rx="2.5" ry="2.5" style="stroke:#000000;stroke-width:0.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-style="italic" lengthAdjust="spacing" text-decoration="line-through" textLength="177" x="904" y="871.8514">settlementWindowStateChange</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="62" x="1084" y="871.8514">Built in TB.</text><ellipse cx="897.5" cy="885.8665" fill="#000000" rx="2.5" ry="2.5" style="stroke:#000000;stroke-width:0.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-style="italic" lengthAdjust="spacing" text-decoration="line-through" textLength="131" x="904" y="889.5575">settlementStateChange</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="62" x="1038" y="889.5575">Built in TB.</text><polygon fill="#181818" points="1765,958.4845,1775,962.4845,1765,966.4845,1769,962.4845" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="874" x2="1771" y1="962.4845" y2="962.4845"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="7" x="881" y="938.9695">9</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="107" x="892" y="921.2635">Update states for:</text><ellipse cx="897.5" cy="935.2785" fill="#000000" rx="2.5" ry="2.5" style="stroke:#000000;stroke-width:0.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-style="italic" lengthAdjust="spacing" text-decoration="line-through" textLength="245" x="904" y="938.9695">settlementParticipantCurrencyStateChange</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="62" x="1152" y="938.9695">Built in TB.</text><ellipse cx="897.5" cy="952.9845" fill="#000000" rx="2.5" ry="2.5" style="stroke:#000000;stroke-width:0.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-style="italic" lengthAdjust="spacing" text-decoration="line-through" textLength="172" x="904" y="956.6755">settlementParticipantCurrency</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="62" x="1079" y="956.6755">Built in TB.</text><line style="stroke:#181818;stroke-width:1.0;" x1="874" x2="916" y1="994.1905" y2="994.1905"/><line style="stroke:#181818;stroke-width:1.0;" x1="916" x2="916" y1="994.1905" y2="1007.1905"/><line style="stroke:#181818;stroke-width:1.0;" x1="875" x2="916" y1="1007.1905" y2="1007.1905"/><polygon fill="#181818" points="885,1003.1905,875,1007.1905,885,1011.1905,881,1007.1905" style="stroke:#181818;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="14" x="881" y="988.3815">10</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="265" x="899" y="988.3815">Process for source state based on the below:</text><rect fill="#EEEEEE" height="3" style="stroke:#EEEEEE;stroke-width:1.0;" width="1823" x="0" y="1037.0435"/><line style="stroke:#000000;stroke-width:1.0;" x1="0" x2="1823" y1="1037.0435" y2="1037.0435"/><line style="stroke:#000000;stroke-width:1.0;" x1="0" x2="1823" y1="1040.0435" y2="1040.0435"/><rect fill="#EEEEEE" height="25.706" style="stroke:#000000;stroke-width:2.0;" width="387" x="718" y="1025.1905"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="370" x="724" y="1043.0875">Settlement State Progress based on Current State START</text><line style="stroke:#181818;stroke-width:1.0;" x1="874" x2="916" y1="1084.6026" y2="1084.6026"/><line style="stroke:#181818;stroke-width:1.0;" x1="916" x2="916" y1="1084.6026" y2="1097.6026"/><line style="stroke:#181818;stroke-width:1.0;" x1="875" x2="916" y1="1097.6026" y2="1097.6026"/><polygon fill="#181818" points="885,1093.6026,875,1097.6026,885,1101.6026,881,1097.6026" style="stroke:#181818;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="148" x="881" y="1078.7936">PENDING_SETTLEMENT</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="188" x="1032" y="1078.7936">-&gt; settlementTransfersPrepare -</text><text fill="#000000" font-family="sans-serif" font-size="13" font-style="italic" lengthAdjust="spacing" textLength="114" x="1223" y="1078.7936">TB 1-Phase transfer.</text><line style="stroke:#181818;stroke-width:1.0;" x1="874" x2="916" y1="1129.3086" y2="1129.3086"/><line style="stroke:#181818;stroke-width:1.0;" x1="916" x2="916" y1="1129.3086" y2="1142.3086"/><line style="stroke:#181818;stroke-width:1.0;" x1="875" x2="916" y1="1142.3086" y2="1142.3086"/><polygon fill="#181818" points="885,1138.3086,875,1142.3086,885,1146.3086,881,1142.3086" style="stroke:#181818;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="169" x="881" y="1123.4996">PS_TRANSFERS_RECORDED</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="188" x="1053" y="1123.4996">-&gt; settlementTransfersReserve -</text><text fill="#000000" font-family="sans-serif" font-size="13" font-style="italic" lengthAdjust="spacing" textLength="157" x="1244" y="1123.4996">TB 2-Phase transfer reserve.</text><line style="stroke:#181818;stroke-width:1.0;" x1="874" x2="916" y1="1174.0146" y2="1174.0146"/><line style="stroke:#181818;stroke-width:1.0;" x1="916" x2="916" y1="1174.0146" y2="1187.0146"/><line style="stroke:#181818;stroke-width:1.0;" x1="875" x2="916" y1="1187.0146" y2="1187.0146"/><polygon fill="#181818" points="885,1183.0146,875,1187.0146,885,1191.0146,881,1187.0146" style="stroke:#181818;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="163" x="881" y="1168.2056">PS_TRANSFERS_RESERVED</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="189" x="1047" y="1168.2056">-&gt; settlementTransfersCommit -</text><text fill="#000000" font-family="sans-serif" font-size="13" font-style="italic" lengthAdjust="spacing" textLength="159" x="1239" y="1168.2056">TB 2-Phase transfer commit.</text><polygon fill="#181818" points="1396,1214.7206,1406,1218.7206,1396,1222.7206,1400,1218.7206" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="874" x2="1402" y1="1218.7206" y2="1218.7206"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="14" x="881" y="1212.9116">11</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="281" x="899" y="1212.9116">Create relevant transfers based on above state.</text><polygon fill="#181818" points="1618,1264.1326,1628,1268.1326,1618,1272.1326,1622,1268.1326" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="1408" x2="1624" y1="1268.1326" y2="1268.1326"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="14" x="1415" y="1253.4706">12</text><text fill="#000000" font-family="sans-serif" font-size="13" font-style="italic" lengthAdjust="spacing" textLength="54" x="1433" y="1244.6176">transfer's</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="123" x="1490" y="1244.6176">Distributed to nodes</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="130" x="1436" y="1262.3236">via the state machine.</text><line style="stroke:#181818;stroke-width:1.0;" x1="1630" x2="1672" y1="1317.5447" y2="1317.5447"/><line style="stroke:#181818;stroke-width:1.0;" x1="1672" x2="1672" y1="1317.5447" y2="1330.5447"/><line style="stroke:#181818;stroke-width:1.0;" x1="1631" x2="1672" y1="1330.5447" y2="1330.5447"/><polygon fill="#181818" points="1641,1326.5447,1631,1330.5447,1641,1334.5447,1637,1330.5447" style="stroke:#181818;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="14" x="1637" y="1302.8827">13</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="51" x="1655" y="1294.0297">[ASYNC]</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="115" x="1655" y="1311.7357">Replication via VSR.</text><polygon fill="#181818" points="885,1375.9567,875,1379.9567,885,1383.9567,881,1379.9567" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="879" x2="1407" y1="1379.9567" y2="1379.9567"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="14" x="891" y="1365.2947">14</text><text fill="#000000" font-family="sans-serif" font-size="13" font-style="italic" lengthAdjust="spacing" textLength="45" x="909" y="1356.4417">transfer</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="70" x="957" y="1356.4417">create error</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="42" x="1030" y="1356.4417">(none)</text><text fill="#000000" font-family="sans-serif" font-size="13" font-style="italic" lengthAdjust="spacing" textLength="128" x="909" y="1374.1477">(Replicated to 2 nodes)</text><rect fill="#EEEEEE" height="3" style="stroke:#EEEEEE;stroke-width:1.0;" width="1823" x="0" y="1409.8097"/><line style="stroke:#000000;stroke-width:1.0;" x1="0" x2="1823" y1="1409.8097" y2="1409.8097"/><line style="stroke:#000000;stroke-width:1.0;" x1="0" x2="1823" y1="1412.8097" y2="1412.8097"/><rect fill="#EEEEEE" height="25.706" style="stroke:#000000;stroke-width:2.0;" width="379" x="722" y="1397.9567"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="362" x="728" y="1415.8537">Settlement State Progress based on Current State STOP</text><polygon fill="#181818" points="1765,1559.6048,1775,1563.6048,1765,1567.6048,1769,1563.6048" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="874" x2="1771" y1="1563.6048" y2="1563.6048"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="14" x="881" y="1504.6778">15</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="358" x="899" y="1451.5597">Perform the following inserts/updates against the database:</text><ellipse cx="904.5" cy="1465.5748" fill="#000000" rx="2.5" ry="2.5" style="stroke:#000000;stroke-width:0.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-style="italic" lengthAdjust="spacing" textLength="58" x="911" y="1469.2658">settlement</text><ellipse cx="904.5" cy="1483.2808" fill="#000000" rx="2.5" ry="2.5" style="stroke:#000000;stroke-width:0.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-style="italic" lengthAdjust="spacing" text-decoration="line-through" textLength="174" x="911" y="1486.9718">settlementContentAggregation</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="62" x="1088" y="1486.9718">Built in TB.</text><ellipse cx="904.5" cy="1500.9868" fill="#000000" rx="2.5" ry="2.5" style="stroke:#000000;stroke-width:0.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-style="italic" lengthAdjust="spacing" text-decoration="line-through" textLength="222" x="911" y="1504.6778">settlementWindowContentStateChange</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="62" x="1136" y="1504.6778">Built in TB.</text><ellipse cx="904.5" cy="1518.6928" fill="#000000" rx="2.5" ry="2.5" style="stroke:#000000;stroke-width:0.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-style="italic" lengthAdjust="spacing" text-decoration="line-through" textLength="149" x="911" y="1522.3838">settlementWindowContent</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="62" x="1063" y="1522.3838">Built in TB.</text><ellipse cx="904.5" cy="1536.3988" fill="#000000" rx="2.5" ry="2.5" style="stroke:#000000;stroke-width:0.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-style="italic" lengthAdjust="spacing" text-decoration="line-through" textLength="177" x="911" y="1540.0898">settlementWindowStateChange</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="62" x="1091" y="1540.0898">Built in TB.</text><ellipse cx="904.5" cy="1554.1048" fill="#000000" rx="2.5" ry="2.5" style="stroke:#000000;stroke-width:0.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-style="italic" lengthAdjust="spacing" textLength="131" x="911" y="1557.7958">settlementStateChange</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="4" x="1045" y="1557.7958">(</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="131" x="1049" y="1557.7958">Final state is settled</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="7" x="1180" y="1557.7958">).</text><polygon fill="#181818" points="745,1591.3109,735,1595.3109,745,1599.3109,741,1595.3109" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="739" x2="873" y1="1595.3109" y2="1595.3109"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="14" x="751" y="1589.5019">16</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="78" x="769" y="1589.5019">Return result</text><polygon fill="#181818" points="584,1623.0169,574,1627.0169,584,1631.0169,580,1627.0169" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="578" x2="733" y1="1627.0169" y2="1627.0169"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="14" x="590" y="1621.2079">17</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="78" x="608" y="1621.2079">Return result</text><polygon fill="#181818" points="346,1654.7229,336,1658.7229,346,1662.7229,342,1658.7229" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="340" x2="572" y1="1658.7229" y2="1658.7229"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="14" x="352" y="1652.9139">18</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="78" x="370" y="1652.9139">Return result</text><polygon fill="#181818" points="98,1686.4289,88,1690.4289,98,1694.4289,94,1690.4289" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="92" x2="334" y1="1690.4289" y2="1690.4289"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="14" x="104" y="1684.6199">19</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="107" x="122" y="1684.6199">Return result with</text><text fill="#000000" font-family="sans-serif" font-size="13" font-style="italic" font-weight="bold" lengthAdjust="spacing" textLength="96" x="232" y="1684.6199">settlementData</text><!--MD5=[0a7fb87edeaa3718177225dc4af94440]
@startuml

participant "Mojaloop Adapter" as dfsp #B0D5FF
note over dfsp
    * Participant Bank A
    * Participant Bank B
end note

box Central-Settlement #FFFFF9
    participant "**API**" as cl_api
    participant "__api__ / Handler" as cs_handler
    participant "__domain__ / Service" as cs_domain
    participant "__models__ / Facade" as cs_facade

note over cl_api
        NodeJS interface
        invokes REST API
    end note

    note over cs_handler
        JSON request decoded & sent
        for processing via a handler
    end note

    note over cs_domain
        Domain folder where the service
        functions are exposed.
    end note

    note over cs_facade
        Facade for storing/retrieving data from
        MySQL and TigerBeetle
    end note
end box

box Storage #F9FFF9
	participant "TigerBeetle Client" as tb_client #D5E8D4
	collections "TigerBeetle Cluster" as tb_nodes #D5E8D4
	database "MySQL" as cl_db #DAE8FC
end box

autonumber
group Trigger Settlement Event - //updateSettlementById//
    dfsp -> cl_api : //JSON// \n**(settlement data)**
    cl_api -> cs_handler : ///settlements/updateSettlementById// \nHandler invoked
    cs_handler -> cs_domain : Service layer invoked\n//updateSettlementById//
    cs_domain -> cs_facade : Domain to facade\n//putById//
    cs_facade -> cl_db : Lookup base settlement data.
    cs_facade -> tb_client : Lookup accounts associated with setlement via CS-TB interface:\n*//**tbLookupAccountsForSettlement**// - Based on settlementId.
    cs_facade -> cs_facade : Determine state and counters for settlement accounts.
    cs_facade -> cl_db : Perform the following inserts against the database:\n*//settlement//\n*//settlementSettlementWindow// for each settlement window.\n*- -//settlementParticipantCurrency//- - Built in TB. \n*- -//settlementWindowContent//- - Built in TB. \n*- -//settlementWindowContentStateChange//- - Built in TB. \n*- -//settlementParticipantCurrencyStateChange//- - Built in TB.\n*- -//settlementWindowStateChange//- - Built in TB.\n*- -//settlementStateChange//- - Built in TB.
    cs_facade -> cl_db : Update states for: \n*- -//settlementParticipantCurrencyStateChange//- - Built in TB.\n*- -//settlementParticipantCurrency//- - Built in TB.
    cs_facade -> cs_facade : Process for source state based on the below:
    == Settlement State Progress based on Current State START ==
    autonumber stop
        cs_facade -> cs_facade : **PENDING_SETTLEMENT** -> settlementTransfersPrepare - //TB 1-Phase transfer.//
        cs_facade -> cs_facade : **PS_TRANSFERS_RECORDED** -> settlementTransfersReserve - //TB 2-Phase transfer reserve.//
        cs_facade -> cs_facade : **PS_TRANSFERS_RESERVED** -> settlementTransfersCommit - //TB 2-Phase transfer commit.//
    autonumber resume
        cs_facade -> tb_client : Create relevant transfers based on above state.
        tb_client -> tb_nodes : //transfer's// Distributed to nodes\n via the state machine.
        tb_nodes -> tb_nodes : **[ASYNC]**\nReplication via VSR.
        tb_client - -> cs_facade : //transfer// create error **(none)**\n//(Replicated to 2 nodes)//
    == Settlement State Progress based on Current State STOP ==
    cs_facade -> cl_db : Perform the following inserts/updates against the database:\n*//settlement//\n*- -//settlementContentAggregation//- - Built in TB. \n*- -//settlementWindowContentStateChange//- - Built in TB.\n*- -//settlementWindowContent//- - Built in TB.\n*- -//settlementWindowStateChange//- - Built in TB.\n*//settlementStateChange// (**Final state is settled**).
    cs_facade - -> cs_domain : Return result
    cs_domain - -> cs_handler : Return result
    cs_handler - -> cl_api : Return result
    cl_api - -> dfsp : Return result with //**settlementData**//
end

@enduml

PlantUML version 1.2022.6(Tue Jun 21 19:34:49 CEST 2022)
(GPL source distribution)
Java Runtime: OpenJDK Runtime Environment
JVM: OpenJDK 64-Bit Server VM
Default Encoding: UTF-8
Language: en
Country: US
--></g></svg>